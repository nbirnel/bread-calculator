#!/usr/bin/env ruby

require 'bread_calculator'

# Boilerplate for adding flags.
loop { case ARGV[0]
  when /--/ then ARGV.shift; break
  when /^-/ then usage("Unknown option: #{ARGV[0].inspect}")
  else break
end; }

@i = 0
@args = @steps = []
@steps[0] = Step.new

def preprocess line
  ing_regex = /^\s+((?<qty>[0-9.]+\s*)(?<units>g)?\s+)?(?<item>.*)/
  h = Hash.new
  if ing_regex =~ line 
    match = Regexp.last_match
    h[:quantity] = match[:qty].strip.to_f
    h[:units]    = match[:units]
    name         = match[:item].strip

    h[:type] = :additives #if it doesn't match anything else
    h[:type] = :flours    if name =~ /flour/
    h[:type] = :liquids   if name =~ /liquid/
    h[:type] = :liquids   if name =~ /water/
    h[:type] = :liquids   if name =~ /egg/
    h[:type] = :liquids   if name =~ /mashed/
    h[:type] = :liquids   if name =~ /milk/
    h[:type] = :additives if name =~ /dry/

    ing = Ingredient.new name, h
  else
    line.strip
  end
end

def close_step
  @steps[@i].techniques = @args
end

def new_step
  @in_prelude = false
  close_step

  @args = []
  @i += 1
  @steps[@i] = Step.new
end

@in_prelude = true
@prelude = ''

while line = gets do
  new_step         && next if line =~ /(^-)|(^\s*$)/
  @prelude << line && next if @in_prelude

  @args << preprocess(line.chomp)
end   

close_step
# because we made a spurious one to begin with
@steps.shift
metadata = {
  :name => 'foo',
  :notes => @prelude,
}

r = Recipe.new metadata, @steps
puts r.bakers_percent_formula
